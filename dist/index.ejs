import e from"fs";import s from"path";import t from"webpack-sources";function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var r,i,o,a,l,c,u,h,f,g;function p(){if(i)return r;i=1;const{ReplaceSource:e}=t;return r=(s,t,n,r)=>s=>{s.forEach((s=>((s,t,n,r)=>s.files.forEach((s=>{let i,o;if(s.match(/.+\.css.*$/)?i=new RegExp(`\\.(${n.classNameRegExp})`,"g"):(s.match(/.+\.js.*$/)||s.match(/.+\.html.*$/))&&(i=new RegExp(`["'.\\s](${n.classNameRegExp})`,"g")),!i)return;if(n.ignorePrefix&&n.ignorePrefixRegExp)throw new Error('Use only either "ignorePrefix" or "ignorePrefixRegExp".');n.ignorePrefixRegExp&&(o=new RegExp(`^${n.ignorePrefixRegExp}`));const a=t.assets[s],l=a.source();let c,u;for(;u=i.exec(l);){const s=u[1];let t=s,i="";if(n.ignorePrefix){let e=n.ignorePrefix;"string"==typeof e&&(e=[e]);for(let t=0;t<e.length;t++)if(s.startsWith(e[t])){i=e[t];break}}if(o){const e=o.exec(s);e&&e.length>0&&(i=e[0])}i&&(t=s.substr(i.length),n.log&&console.log(`Skip the prefix ${chalk.red(i)} of ${chalk.green(s)}`));const l=r.generateClassName(t,n);c||(c=new e(a));const h=u.index+u[0].indexOf(u[1]),f=`${i}${l.name}`;c.replace(h,h+s.length-1,f)}c&&(t.assets[s]=c)})))(s,t,n,r)))},r}function m(){if(c)return l;c=1;const e=function(){if(a)return o;let e;a=1;try{e=require("chalk")}catch(s){e={green:e=>e,yellow:e=>e}}return o=e}(),s="abcdefghijklmnopqrstuvwxyz_".split(""),t="abcdefghijklmnopqrstuvwxyz_-0123456789".split("");function n(){this.newClassMap={},this.newClassSize=-1,this.context={},this.unusedClass=[]}return n.prototype={init(e={},s=-1,t=[]){this.newClassMap=e,this.newClassSize=s,this.unusedClass=t},defaultClassGenerator:function(){const e=[];let n=(this.newClassSize-this.newClassSize%s.length)/s.length;if(n>0)for(;;){n-=1;const s=n%t.length,r=t[s];if(e.push(r),n-=s,0===n)break;n/=t.length}const r=this.newClassSize%s.length;return`${s[r]}${e.join("")}`},generateClassName:function(s,t){console.log(s),s=s.replace(/\\/g,"");const n=this.newClassMap[s];if(n)return-1===this.newClassMap[s].num&&(this.unusedClass=this.unusedClass.filter((e=>e!==s)),this.newClassMap[s].num=0),this.newClassMap[s].num++,n;let r;if(this.unusedClass.length>0){const e=this.unusedClass.shift();r=this.newClassMap[e].name,delete this.newClassMap[e]}else this.newClassSize++;if(r||(r=t.classGenerator?t.classGenerator(s,t,this.context):this.defaultClassGenerator()),t.reserveClassName&&t.reserveClassName.includes(r))return t.log&&console.log(`The class name has been reserved. ${e.green(r)}`),this.generateClassName(s,t);t.log&&console.log(`Minify class name from ${e.green(s)} to ${e.green(r)}`);const i={name:r,num:1};return this.newClassMap[s]=i,i}},l=n}function w(){if(h)return u;h=1;const t=s,n=e,r=process.cwd(),i=[".git",".nuxt","plugins",".vscode","middleware","node_modules","static","store"];function o(e,s){return new Promise((t=>{n.writeFile(e,s.replace(/(?<!:|-)class="([^"]+)"/g,((e,s)=>`class="${s.split(/\s+/).map((e=>e.startsWith("cl-")||e.startsWith("no-")?e:`cl-${e}`)).join(" ")}"`)).replace(/\.((?!cl-|no-)[a-zA-Z0-9_-]+)(:[a-zA-Z0-9_-]+)?\s*\{/g,".cl-$1$2 {"),"utf8",(e=>{e?console.log("写入失败",e):(console.log("写入成功"),t())}))}))}function a(e){return new Promise((s=>{n.readdir(e,((r,l)=>{r?console.error(`无法读取目录: ${e}`,r):l.forEach((r=>{if(i.includes(r))return void s();const l=t.join(e,r);n.stat(l,(async(e,t)=>{e?console.error(`无法获取文件状态: ${l}`,e):t.isDirectory()?await a(l):((l.endsWith(".vue")||l.endsWith(".less"))&&n.readFile(l,"utf8",(async(e,s)=>{e||await o(l,s)})),s())}))}))}))}))}return u=function(e){const s=t.resolve(r,e);return n.statSync(s).isFile&&n.readFile(s,"utf8",((e,t)=>{if(!e)return o(s,t)})),a(s)}}var C=function(){if(g)return f;g=1;const t=e,n=s,r=p(),i=m(),o=w();let a;const l=n.resolve(__dirname,"cache.json");return console.log(l),f=class{constructor(e={}){this.opts=e}apply(e){e.hooks.compilation.tap("MangleCssClassPluginHooks",(s=>{s.hooks.optimizeChunkAssets.tapAsync("MangleCssClassPluginOptimizeChunkAssetsHooks",(async(n,c)=>{if(this.opts.replacePath&&await o(this.opts.replacePath),!a){a=new i,await(e=>new Promise(((s,n)=>{t.access(e,t.constants.F_OK,(r=>{r?t.writeFile(e,"{}",(e=>{e?n(e):s()})):s()}))})))(l);const e=await new Promise(((e,s)=>{t.readFile(l,"utf8",((t,n)=>{t&&s(t),e(JSON.parse(n))}))}));if(e?._newClassSize?.name){console.log("have cache");const s=[];for(const t in e)-1===e[t].num?s.push(t):e[t].num=0;a.init(e,e._newClassSize.name,s)}}((e,s,t,n)=>{const i=r(e,s,t,n);return(e,s)=>{i(e),s()}})(e,s,this.opts,a)(n,c)}))})),e.hooks.afterEmit.tapAsync("SaveDataPlugin",((e,s)=>{const n=a.newClassMap;for(const e in n)n[e].num<=0&&(n[e].num=-1);n._newClassSize={name:a.newClassSize,num:1},t.writeFile(l,JSON.stringify(n),"utf8",(e=>{e&&console.log(e)})),s()}))}},f}(),d=n(C);export{d as default};
