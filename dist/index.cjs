"use strict";var e,s,t,n,r,i,a,o,l,c,u=require("fs"),h=require("path"),f=require("webpack-sources");function g(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function p(){if(s)return e;s=1;const{ReplaceSource:t}=f;return e=(e,s,n,r)=>e=>{e.forEach((e=>((e,s,n,r)=>e.files.forEach((e=>{let i,a;if(e.match(/.+\.css.*$/)?i=new RegExp(`\\.(${n.classNameRegExp})`,"g"):(e.match(/.+\.js.*$/)||e.match(/.+\.html.*$/))&&(i=new RegExp(`["'.\\s](${n.classNameRegExp})`,"g")),!i)return;if(n.ignorePrefix&&n.ignorePrefixRegExp)throw new Error('Use only either "ignorePrefix" or "ignorePrefixRegExp".');n.ignorePrefixRegExp&&(a=new RegExp(`^${n.ignorePrefixRegExp}`));const o=s.assets[e],l=o.source();let c,u;for(;u=i.exec(l);){const e=u[1];let s=e,i="";if(n.ignorePrefix){let s=n.ignorePrefix;"string"==typeof s&&(s=[s]);for(let t=0;t<s.length;t++)if(e.startsWith(s[t])){i=s[t];break}}if(a){const s=a.exec(e);s&&s.length>0&&(i=s[0])}i&&(s=e.substr(i.length),n.log&&console.log(`Skip the prefix ${chalk.red(i)} of ${chalk.green(e)}`));const l=r.generateClassName(s,n);c||(c=new t(o));const h=u.index+u[0].indexOf(u[1]),f=`${i}${l.name}`;c.replace(h,h+e.length-1,f)}c&&(s.assets[e]=c)})))(e,s,n,r)))},e}function w(){if(i)return r;i=1;const e=function(){if(n)return t;let e;n=1;try{e=require("chalk")}catch(s){e={green:e=>e,yellow:e=>e}}return t=e}(),s="abcdefghijklmnopqrstuvwxyz_".split(""),a="abcdefghijklmnopqrstuvwxyz_-0123456789".split("");function o(){this.newClassMap={},this.newClassSize=-1,this.context={},this.unusedClass=[]}return o.prototype={init(e={},s=-1,t=[]){this.newClassMap=e,this.newClassSize=s,this.unusedClass=t},defaultClassGenerator:function(){const e=[];let t=(this.newClassSize-this.newClassSize%s.length)/s.length;if(t>0)for(;;){t-=1;const s=t%a.length,n=a[s];if(e.push(n),t-=s,0===t)break;t/=a.length}const n=this.newClassSize%s.length;return`${s[n]}${e.join("")}`},generateClassName:function(s,t){console.log(s),s=s.replace(/\\/g,"");const n=this.newClassMap[s];if(n)return-1===this.newClassMap[s].num&&(this.unusedClass=this.unusedClass.filter((e=>e!==s)),this.newClassMap[s].num=0),this.newClassMap[s].num++,n;let r;if(this.unusedClass.length>0){const e=this.unusedClass.shift();r=this.newClassMap[e].name,delete this.newClassMap[e]}else this.newClassSize++;if(r||(r=t.classGenerator?t.classGenerator(s,t,this.context):this.defaultClassGenerator()),t.reserveClassName&&t.reserveClassName.includes(r))return t.log&&console.log(`The class name has been reserved. ${e.green(r)}`),this.generateClassName(s,t);t.log&&console.log(`Minify class name from ${e.green(s)} to ${e.green(r)}`);const i={name:r,num:1};return this.newClassMap[s]=i,i}},r=o}function m(){if(o)return a;o=1;const e=h,s=u,t=process.cwd(),n=[".git",".nuxt","plugins",".vscode","middleware","node_modules","static","store"];function r(e,t){return new Promise((n=>{s.writeFile(e,t.replace(/(?<!:|-)class="([^"]+)"/g,((e,s)=>`class="${s.split(/\s+/).map((e=>e.startsWith("cl-")||e.startsWith("no-")?e:`cl-${e}`)).join(" ")}"`)).replace(/\.((?!cl-|no-)[a-zA-Z0-9_-]+)(:[a-zA-Z0-9_-]+)?\s*\{/g,".cl-$1$2 {"),"utf8",(e=>{e?console.log("写入失败",e):(console.log("写入成功"),n())}))}))}function i(t){return new Promise((a=>{s.readdir(t,((o,l)=>{o?console.error(`无法读取目录: ${t}`,o):l.forEach((o=>{if(n.includes(o))return void a();const l=e.join(t,o);s.stat(l,(async(e,t)=>{e?console.error(`无法获取文件状态: ${l}`,e):t.isDirectory()?await i(l):((l.endsWith(".vue")||l.endsWith(".less"))&&s.readFile(l,"utf8",(async(e,s)=>{e||await r(l,s)})),a())}))}))}))}))}return a=function(n){const a=e.resolve(t,n);return s.statSync(a).isFile&&s.readFile(a,"utf8",((e,s)=>{if(!e)return r(a,s)})),i(a)}}var C=function(){if(c)return l;c=1;const e=u,s=h,t=p(),n=w(),r=m();let i;const a=s.resolve(__dirname,"cache.json");return console.log(a),l=class{constructor(e={}){this.opts=e}apply(s){s.hooks.compilation.tap("MangleCssClassPluginHooks",(o=>{o.hooks.optimizeChunkAssets.tapAsync("MangleCssClassPluginOptimizeChunkAssetsHooks",(async(l,c)=>{if(this.opts.replacePath&&await r(this.opts.replacePath),!i){i=new n,await(s=>new Promise(((t,n)=>{e.access(s,e.constants.F_OK,(r=>{r?e.writeFile(s,"{}",(e=>{e?n(e):t()})):t()}))})))(a);const s=await new Promise(((s,t)=>{e.readFile(a,"utf8",((e,n)=>{e&&t(e),s(JSON.parse(n))}))}));if(s?._newClassSize?.name){console.log("have cache");const e=[];for(const t in s)-1===s[t].num?e.push(t):s[t].num=0;i.init(s,s._newClassSize.name,e)}}((e,s,n,r)=>{const i=t(e,s,n,r);return(e,s)=>{i(e),s()}})(s,o,this.opts,i)(l,c)}))})),s.hooks.afterEmit.tapAsync("SaveDataPlugin",((s,t)=>{const n=i.newClassMap;for(const e in n)n[e].num<=0&&(n[e].num=-1);n._newClassSize={name:i.newClassSize,num:1},e.writeFile(a,JSON.stringify(n),"utf8",(e=>{e&&console.log(e)})),t()}))}},l}(),d=g(C);module.exports=d;
